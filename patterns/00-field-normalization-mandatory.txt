# MANDATORY PATTERN - Field Normalization Layer
# This MUST be the first node after EVERY webhook

## CRITICAL: This MUST be implemented before ANY webhook integration

### The Problem We're Solving
Webhook fields are NEVER stable. We discovered:
- Kajabi sends 15+ variations of core fields
- Case sensitivity varies randomly
- Field names change without notice
- Missing this = 100% failure rate

### Implementation Requirements

#### 1. Smart Field Mapper Node (REQUIRED)
Position: Immediately after webhook node
Type: Code node
Language: JavaScript

#### 2. Production Code (DO NOT MODIFY WITHOUT TESTING)
const input = $input.first().json;
const normalized = {};
const mappedFields = new Set();

// Core field mappings - UPDATE WEEKLY from Field_Mapping_Log
const fieldMappings = {
  email: ['email', 'Email', 'EMAIL', 'email_address', 'emailAddress', 'e-mail', 'contact_email', 'email_address_1', 'user_email', 'primary_email'],
  phone: ['phone', 'Phone', 'PHONE', 'phone_number', 'phoneNumber', 'mobile', 'cellphone', 'telephone', 'phone_intl', 'mobile_intl'],
  name: ['name', 'Name', 'NAME', 'full_name', 'fullName', 'contact_name', 'display_name'],
  first_name: ['first_name', 'firstName', 'fname', 'given_name', 'forename'],
  last_name: ['last_name', 'lastName', 'lname', 'surname', 'family_name'],
  company: ['company', 'Company', 'company_name', 'companyName', 'organization', 'org', 'business'],
  title: ['title', 'Title', 'job_title', 'jobTitle', 'position', 'role'],
  source_form: ['source_form', 'form_name', 'formName', 'source', 'form_id'],
  interested_in_coaching: ['interested_in_coaching', 'coaching_interest', 'wants_coaching'],
  linkedin_url: ['linkedin_url', 'linkedin', 'linkedinUrl', 'linkedin_profile']
};

// Case-insensitive field finder
function findField(aliases) {
  for (const key of Object.keys(input)) {
    if (aliases.some(alias => alias.toLowerCase() === key.toLowerCase())) {
      mappedFields.add(key);
      return input[key];
    }
  }
  return null;
}

// Map all fields
Object.entries(fieldMappings).forEach(([normalizedName, aliases]) => {
  const value = findField(aliases);
  if (value !== null && value !== undefined && value !== '') {
    normalized[normalizedName] = value;
  }
});

// Auto-split full name
if (normalized.name && !normalized.first_name) {
  const parts = normalized.name.trim().split(/\s+/);
  normalized.first_name = parts[0] || '';
  normalized.last_name = parts.slice(1).join(' ') || '';
}

// Handle booleans for Airtable
['interested_in_coaching', 'qualified_lead', 'contacted'].forEach(field => {
  if (normalized[field] !== undefined) {
    const val = String(normalized[field]).toLowerCase();
    normalized[field] = ['true', 'yes', '1', 'on', 'y', 'checked'].includes(val);
  }
});

// Track unknown fields for weekly review
const unknownFields = Object.keys(input).filter(k => !mappedFields.has(k));

// Log to monitoring table if unknowns found
if (unknownFields.length > 0) {
  // Will be handled by separate Airtable logging node
}

return {
  normalized,
  original: input,
  unknownFields,
  mappingSuccess: Object.keys(normalized).length > 0,
  timestamp: new Date().toISOString()
};
// Updated 2025-07-22: Added new Kajabi variations and boolean options from external validation; confirmed Airtable checkbox support for 'checked'/'y'.

### Testing Requirements
- Test with minimum 10 payload variations
- Verify 95%+ field capture rate
- Check Field_Mapping_Log table for unknowns
- Only mark complete after ALL tests pass

### Integration Rules
- ALL downstream nodes must reference: $node["Smart Field Mapper"].json.normalized
- NEVER reference webhook data directly
- If mapping fails, route to human review queue