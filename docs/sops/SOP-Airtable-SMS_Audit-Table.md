# SOP: Airtable Table - SMS_Audit

## 1. Executive Summary

- **Purpose**: The `SMS_Audit` table provides a granular, message-by-message log of all outbound and inbound SMS activity. It serves as the single source of truth for message status (sent, delivered, failed) and is critical for troubleshooting, reporting, and ensuring compliance.
- **Scope**: This SOP covers the structure and data flow of the `SMS_Audit` table.
- **Owner**: System Architect

## 2. How it Works

The `SMS_Audit` table is populated exclusively by two n8n workflows:

1.  **`UYSP-SMS-Scheduler-CLEAN`**: When an SMS is sent via the SimpleTexting API, this workflow immediately creates a new record in the `SMS_Audit` table.
    - It logs the `Campaign ID`, `Phone`, `Text`, `Lead Record ID`, and sets the initial `Status` to "Sent".
    - The `Sent At` timestamp is also recorded.
2.  **`UYSP-ST-Delivery V2`**: This workflow is triggered by a webhook from SimpleTexting when a message's delivery status is updated (e.g., delivered, undelivered).
    - It finds the corresponding "Sent" record in the audit table using the `Campaign ID` and `Phone` number.
    - It then updates that record with the new `Status` (e.g., "Delivered", "Failed"), the `Delivery At` timestamp, and carrier information.

This two-step process ensures a complete lifecycle view for every message sent.

## 3. Field Dictionary

| Field Name       | Type           | Description                                                                                             |
| ---------------- | -------------- | ------------------------------------------------------------------------------------------------------- |
| **Event**        | `singleLineText` | A descriptor of the event (e.g., `SMS Sent`, `Delivery Update`).                                          |
| **Campaign ID**  | `singleLineText` | The unique identifier for the SMS message, generated by SimpleTexting upon sending. **Used as a key.**  |
| **Phone**        | `singleLineText` | The recipient's phone number. **Used as a key.**                                                         |
| **Status**       | `singleSelect` | The current status of the message (`Sent`, `Delivered`, `Undelivered`, `Failed`, `Clicked`).               |
| **Carrier**      | `singleLineText` | The mobile carrier of the recipient's phone number, provided by the delivery webhook.                     |
| **Lead Record ID** | `singleLineText` | The Airtable Record ID of the associated lead from the `Leads` table.                                     |
| **Text**         | `multilineText`| The exact body of the SMS message that was sent.                                                          |
| **Sent At**      | `dateTime`     | The timestamp when the message was sent by the `SMS Scheduler` workflow.                                  |
| **Delivery At**  | `dateTime`     | The timestamp when the final delivery status was received from the SimpleTexting webhook.                 |
| **Webhook Raw**  | `multilineText`| The raw JSON payload received from the SimpleTexting delivery webhook, for debugging purposes.              |
| **Clicked**      | `checkbox`     | (Future Use) A checkbox that will be ticked if the link in the SMS is clicked.                            |
| **Clicked At**   | `dateTime`     | (Future Use) The timestamp of the link click event.                                                       |

## 4. Maintenance & Troubleshooting

- **Missing Delivery Status**: If a record has a `Status` of "Sent" but is never updated to "Delivered" or "Failed", it could indicate an issue with the `UYSP-ST-Delivery V2` webhook. Check the webhook URL in SimpleTexting and the execution history of the workflow in n8n for errors.
- **Incorrect Data**: If data in the audit log appears incorrect, check the corresponding n8n workflow execution (`SMS Scheduler` for sending, `ST Delivery` for updates) to inspect the data that was mapped to Airtable.

## 5. Related SOPs & System Documents

- **SOPs**:
    - `SOP-Workflow-SMS-Scheduler.md`
    - `SOP-Workflow-ST-Delivery.md`
- **Architecture**:
    - `docs/architecture/AIRTABLE-SCHEMA.md`
