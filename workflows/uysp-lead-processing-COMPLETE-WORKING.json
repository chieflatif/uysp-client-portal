{
  "createdAt": "2025-07-21T22:10:00.000Z",
  "updatedAt": "2025-07-21T22:10:00.000Z",
  "id": "NEW_WORKFLOW_ID",
  "name": "UYSP Lead Processing - COMPLETE WORKING VERSION",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "kajabi-leads",
        "authentication": "headerAuth",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-node",
      "name": "Kajabi Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [80, 180],
      "credentials": {
        "httpHeaderAuth": "VNS3JAPKgDxyNQa3"
      }
    },
    {
      "parameters": {
        "jsCode": "// API Key Validation with proper error handling\nconst VALID_API_KEY = \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIyOWQwYWM3Ni0xYjBlLTRmMGItYTlkZC1iNzEwZDI0NzZlZmEiLCJpc3MiOiJuOG4iLCJhdWQiOiJwdWJsaWMtYXBpIiwiaWF0IjoxNzUyMDYzNTE4LCJleHAiOjE3NTk3ODgwMDB9.IRZEs36NXR6WHcZb1PiC109S70tGKsmzP86zWpun3qg\";\n\nconst headers = $json.headers || {};\nconst apiKey = headers[\"x-api-key\"];\n\nif (!apiKey) {\n  throw new Error(\"Missing x-api-key header\");\n}\n\nif (apiKey !== VALID_API_KEY) {\n  throw new Error(\"Invalid API key\");\n}\n\nconsole.log(\"API Key validation successful\");\nreturn $json;"
      },
      "id": "api-validation",
      "name": "API Key Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 180]
    },
    {
      "parameters": {
        "jsCode": "// Enhanced Smart Field Mapper with comprehensive logging\nconst fieldMappings = {\n  email: ['email', 'Email', 'EMAIL', 'email_address', 'emailAddress', 'e-mail', 'contact_email'],\n  phone: ['phone', 'Phone', 'PHONE', 'phone_number', 'phoneNumber', 'mobile', 'cell'],\n  first_name: ['first_name', 'firstName', 'fname', 'given_name'],\n  last_name: ['last_name', 'lastName', 'lname', 'surname'],\n  full_name: ['name', 'Name', 'full_name', 'fullName'],\n  company: ['company', 'Company', 'company_name', 'organization'],\n  title: ['title', 'Title', 'job_title', 'role', 'position'],\n  linkedin: ['linkedin', 'LinkedIn', 'linkedin_url', 'linkedinProfile']\n};\n\nconst otherFields = {\n  source_form: ['source_form', 'source', 'form_name', 'utm_source'],\n  interested_in_coaching: ['interested_in_coaching', 'coaching_interest'],\n  request_id: ['request_id', 'requestId', 'request_ID']\n};\n\nconst normalized = {};\nconst unmappedFields = [];\nconst mappingLog = [];\n\nconst webhookData = $input.item.json;\nconst input = webhookData.body || webhookData;\n\nconsole.log('Input data received:', JSON.stringify(input, null, 2));\n\n// Map standard fields\nObject.keys(fieldMappings).forEach(targetField => {\n  const variations = fieldMappings[targetField];\n  let found = false;\n  \n  for (const variation of variations) {\n    const inputKey = Object.keys(input).find(key => \n      key.toLowerCase() === variation.toLowerCase()\n    );\n    \n    if (inputKey && input[inputKey] !== undefined && input[inputKey] !== '') {\n      normalized[targetField] = input[inputKey];\n      mappingLog.push(`Mapped ${inputKey} → ${targetField}`);\n      found = true;\n      break;\n    }\n  }\n  \n  if (!found) {\n    normalized[targetField] = null;\n    mappingLog.push(`No mapping found for ${targetField}, set to null`);\n  }\n});\n\n// Map other fields\nObject.keys(otherFields).forEach(targetField => {\n  const variations = otherFields[targetField];\n  \n  for (const variation of variations) {\n    const inputKey = Object.keys(input).find(key => \n      key.toLowerCase() === variation.toLowerCase()\n    );\n    \n    if (inputKey && input[inputKey] !== undefined && input[inputKey] !== '') {\n      normalized[targetField] = input[inputKey];\n      mappingLog.push(`Mapped ${inputKey} → ${targetField}`);\n      break;\n    }\n  }\n});\n\n// Handle name splitting\nif (normalized.full_name && !normalized.first_name) {\n  const parts = normalized.full_name.split(' ');\n  normalized.first_name = parts[0] || null;\n  normalized.last_name = parts.slice(1).join(' ') || null;\n  mappingLog.push(`Split full_name into first/last`);\n}\n\n// Boolean conversion for interested_in_coaching\nif (normalized.interested_in_coaching) {\n  const value = normalized.interested_in_coaching.toString().toLowerCase();\n  normalized.interested_in_coaching = ['yes', 'true', '1', 'on'].includes(value);\n}\n\n// Find unmapped fields\nObject.keys(input).forEach(key => {\n  const wasMapped = mappingLog.some(log => log.includes(key));\n  if (!wasMapped) {\n    unmappedFields.push(key);\n  }\n});\n\n// Add metadata\nnormalized._mapping_metadata = {\n  original_field_count: Object.keys(input).length,\n  mapped_field_count: Object.keys(normalized).length - 1,\n  unmapped_fields: unmappedFields,\n  mapping_timestamp: new Date().toISOString(),\n  success_rate: ((Object.keys(normalized).length - 1) / Object.keys(input).length * 100).toFixed(2) + '%'\n};\n\nif (unmappedFields.length > 0) {\n  console.log('Unknown fields detected:', unmappedFields);\n}\n\nif (!normalized.email) {\n  throw new Error('CRITICAL: No email field found in payload. Cannot process lead.');\n}\n\nconsole.log('Normalized data:', JSON.stringify(normalized, null, 2));\nconsole.log('Mapping log:', mappingLog);\n\nreturn { \n  ...webhookData,\n  normalized,\n  unmappedFields,\n  mappingLog\n};"
      },
      "id": "field-mapper",
      "name": "Smart Field Mapper",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [520, 180]
    },
    {
      "parameters": {
        "authentication": "airtableTokenApi",
        "resource": "record",
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appuBf0fTe8tp8ZaF",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "tblSk2Ikg21932uE0",
          "mode": "list"
        },
        "filterByFormula": "OR({email} = '{{ $json.normalized.email }}', {phone_primary} = '{{ $json.normalized.phone }}')",
        "returnAll": true,
        "options": {}
      },
      "id": "airtable-search",
      "name": "Airtable Duplicate Search",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [740, 180],
      "alwaysOutputData": true,
      "credentials": {
        "airtableTokenApi": "G40CUwPD7dTJJofz"
      }
    },
    {
      "parameters": {
        "jsCode": "// Enhanced Duplicate Handler with comprehensive logging\nconst searchResults = $input.first().json;\nconst normalizedData = $node[\"Smart Field Mapper\"].json;\n\nconsole.log('Search Results from Airtable:', JSON.stringify(searchResults, null, 2));\nconsole.log('Normalized Data:', JSON.stringify(normalizedData.normalized, null, 2));\n\nconst hasRecords = searchResults.records && searchResults.records.length > 0;\n\nif (hasRecords) {\n  const existingRecord = searchResults.records[0];\n  const currentCount = existingRecord.fields.duplicate_count || 0;\n  const newCount = currentCount + 1;\n  \n  console.log(`DUPLICATE FOUND! Existing record: ${existingRecord.id}, current count: ${currentCount}, new count: ${newCount}`);\n  \n  return {\n    duplicate: true,\n    duplicateCount: newCount,\n    recordId: existingRecord.id,\n    existingFields: existingRecord.fields,\n    ...normalizedData\n  };\n} else {\n  console.log('NO DUPLICATE FOUND - Creating new record');\n  \n  return {\n    duplicate: false,\n    duplicateCount: 0,\n    recordId: null,\n    ...normalizedData\n  };\n}"
      },
      "id": "duplicate-handler",
      "name": "Duplicate Detection Logic",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [960, 180]
    },
    {
      "parameters": {
        "conditions": {\n          \"options\": {\n            \"caseSensitive\": true,\n            \"leftValue\": \"\",\n            \"typeValidation\": \"loose\"\n          },\n          \"conditions\": [\n            {\n              \"leftValue\": \"={{$json.duplicate}}\",\n              \"rightValue\": \"true\",\n              \"operator\": {\n                \"type\": \"boolean\",\n                \"operation\": \"equals\"\n              }\n            }\n          ],\n          \"combinator\": \"and\"\n        },\n        \"options\": {}\n      },\n      \"id\": \"duplicate-router\",\n      \"name\": \"Duplicate Decision Router\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"typeVersion\": 2,\n      \"position\": [1180, 180]\n    },\n    {\n      \"parameters\": {\n        \"authentication\": \"airtableTokenApi\",\n        \"resource\": \"record\",\n        \"operation\": \"update\",\n        \"base\": {\n          \"__rl\": true,\n          \"value\": \"appuBf0fTe8tp8ZaF\",\n          \"mode\": \"list\"\n        },\n        \"table\": {\n          \"__rl\": true,\n          \"value\": \"tblSk2Ikg21932uE0\",\n          \"mode\": \"list\"\n        },\n        \"recordId\": \"={{ $json.recordId }}\",\n        \"columns\": {\n          \"mappingMode\": \"defineBelow\",\n          \"value\": {\n            \"duplicate_count\": \"={{$json.duplicateCount}}\",\n            \"last_updated\": \"={{$now.toISO()}}\",\n            \"reengagement_count\": \"={{ ($json.existingFields.reengagement_count || 0) + 1 }}\"\n          },\n          \"matchingColumns\": [],\n          \"schema\": []\n        },\n        \"options\": {}\n      },\n      \"id\": \"airtable-update\",\n      \"name\": \"Update Existing Record\",\n      \"type\": \"n8n-nodes-base.airtable\",\n      \"typeVersion\": 2.1,\n      \"position\": [1400, 100],\n      \"credentials\": {\n        \"airtableTokenApi\": \"G40CUwPD7dTJJofz\"\n      }\n    },\n    {\n      \"parameters\": {\n        \"authentication\": \"airtableTokenApi\",\n        \"resource\": \"record\",\n        \"operation\": \"create\",\n        \"base\": {\n          \"__rl\": true,\n          \"value\": \"appuBf0fTe8tp8ZaF\",\n          \"mode\": \"list\"\n        },\n        \"table\": {\n          \"__rl\": true,\n          \"value\": \"tblSk2Ikg21932uE0\",\n          \"mode\": \"list\"\n        },\n        \"columns\": {\n          \"mappingMode\": \"defineBelow\",\n          \"value\": {\n            \"email\": \"={{$json.normalized.email}}\",\n            \"first_name\": \"={{$json.normalized.first_name}}\",\n            \"last_name\": \"={{$json.normalized.last_name}}\",\n            \"phone_primary\": \"={{$json.normalized.phone}}\",\n            \"company_input\": \"={{$json.normalized.company}}\",\n            \"title_current\": \"={{$json.normalized.title}}\",\n            \"linkedin_url\": \"={{$json.normalized.linkedin}}\",\n            \"interested_in_coaching\": \"={{$json.normalized.interested_in_coaching}}\",\n            \"request_id\": \"={{$json.normalized.request_id || $json.request_id}}\",\n            \"lead_source\": \"={{$json.normalized.source_form}}\",\n            \"lead_status\": \"New\",\n            \"created_date\": \"={{$now.toISO()}}\",\n            \"last_updated\": \"={{$now.toISO()}}\",\n            \"enrichment_status\": \"pending\",\n            \"qualification_score\": 0,\n            \"icp_score\": 0,\n            \"reengagement_count\": 0,\n            \"duplicate_count\": 0,\n            \"phase_1_status\": \"pending\",\n            \"phase_2_status\": \"pending\",\n            \"phase_3_status\": \"pending\",\n            \"phase_4_status\": \"pending\",\n            \"phase_5_status\": \"pending\",\n            \"phase_6_status\": \"pending\",\n            \"sms_opt_out\": false,\n            \"email_opt_out\": false,\n            \"is_test_mode\": false\n          },\n          \"matchingColumns\": [],\n          \"schema\": []\n        },\n        \"options\": {}\n      },\n      \"id\": \"airtable-create\",\n      \"name\": \"Create New Record\",\n      \"type\": \"n8n-nodes-base.airtable\",\n      \"typeVersion\": 2.1,\n      \"position\": [1400, 260],\n      \"credentials\": {\n        \"airtableTokenApi\": \"G40CUwPD7dTJJofz\"\n      }\n    },\n    {\n      \"parameters\": {\n        \"jsCode\": \"// Success Response with comprehensive data\\nconst result = {\\n  success: true,\\n  timestamp: new Date().toISOString(),\\n  workflow_version: 'COMPLETE_WORKING_v1.0',\\n  message: 'Lead processed successfully',\\n  data: $json\\n};\\n\\nconsole.log('Final workflow result:', JSON.stringify(result, null, 2));\\n\\nreturn result;\"\n      },\n      \"id\": \"success-response\",\n      \"name\": \"Success Response\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"typeVersion\": 2,\n      \"position\": [1620, 180]\n    }\n  ],\n  \"connections\": {\n    \"Kajabi Webhook\": {\n      \"main\": [[{\"node\": \"API Key Validation\", \"type\": \"main\", \"index\": 0}]]\n    },\n    \"API Key Validation\": {\n      \"main\": [[{\"node\": \"Smart Field Mapper\", \"type\": \"main\", \"index\": 0}]]\n    },\n    \"Smart Field Mapper\": {\n      \"main\": [[{\"node\": \"Airtable Duplicate Search\", \"type\": \"main\", \"index\": 0}]]\n    },\n    \"Airtable Duplicate Search\": {\n      \"main\": [[{\"node\": \"Duplicate Detection Logic\", \"type\": \"main\", \"index\": 0}]]\n    },\n    \"Duplicate Detection Logic\": {\n      \"main\": [[{\"node\": \"Duplicate Decision Router\", \"type\": \"main\", \"index\": 0}]]\n    },\n    \"Duplicate Decision Router\": {\n      \"main\": [\n        [{\"node\": \"Update Existing Record\", \"type\": \"main\", \"index\": 0}],\n        [{\"node\": \"Create New Record\", \"type\": \"main\", \"index\": 0}]\n      ]\n    },\n    \"Update Existing Record\": {\n      \"main\": [[{\"node\": \"Success Response\", \"type\": \"main\", \"index\": 0}]]\n    },\n    \"Create New Record\": {\n      \"main\": [[{\"node\": \"Success Response\", \"type\": \"main\", \"index\": 0}]]\n    }\n  },\n  \"settings\": {\n    \"executionOrder\": \"v1\",\n    \"saveDataErrorExecution\": \"all\",\n    \"saveDataSuccessExecution\": \"all\",\n    \"saveExecutionProgress\": true,\n    \"saveManualExecutions\": true\n  },\n  \"staticData\": null,\n  \"meta\": {\n    \"templateCredsSetupCompleted\": true,\n    \"instanceId\": \"complete-working-instance\"\n  },\n  \"versionId\": \"complete-working-v1.0\",\n  \"triggerCount\": 1\n}