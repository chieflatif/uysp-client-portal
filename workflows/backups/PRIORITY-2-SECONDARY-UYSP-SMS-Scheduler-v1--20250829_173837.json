{
  "createdAt": "2025-08-28T18:27:08.414Z",
  "updatedAt": "2025-08-28T18:35:49.000Z",
  "id": "LVmCQpTbKDxfISG6",
  "name": "UYSP-SMS-Scheduler (v1)",
  "active": false,
  "isArchived": true,
  "nodes": [
    {
      "id": "start",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -760,
        -80
      ],
      "parameters": {}
    },
    {
      "id": "listLeads",
      "name": "List Leads (SMS Pipeline)",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        -540,
        -80
      ],
      "parameters": {
        "operation": "list",
        "base": {
          "mode": "id",
          "value": "app6cU9HecxLpgT0P"
        },
        "table": {
          "mode": "list",
          "value": "tblYUvhGADerbD8EO",
          "__rl": true
        },
        "returnAll": true,
        "additionalFields": {
          "viewId": "SMS Pipeline"
        }
      },
      "credentials": {
        "airtableTokenApi": {
          "id": "Zir5IhIPeSQs72LR",
          "name": "Airtable UYSP Option C"
        }
      }
    },
    {
      "id": "getSettings",
      "name": "Get Settings",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        -540,
        -220
      ],
      "parameters": {
        "operation": "list",
        "base": {
          "mode": "id",
          "value": "app6cU9HecxLpgT0P"
        },
        "table": {
          "mode": "list",
          "value": "tblErXnFNMKYhh3Xr",
          "__rl": true
        },
        "returnAll": false,
        "options": {
          "maxRecords": 1
        }
      },
      "credentials": {
        "airtableTokenApi": {
          "id": "Zir5IhIPeSQs72LR",
          "name": "Airtable UYSP Option C"
        }
      }
    },
    {
      "id": "listTemplates",
      "name": "List Templates",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        -320,
        -220
      ],
      "parameters": {
        "operation": "list",
        "base": {
          "mode": "id",
          "value": "app6cU9HecxLpgT0P"
        },
        "table": {
          "mode": "list",
          "value": "tblsSX9dYMnexdAa7",
          "__rl": true
        },
        "returnAll": true,
        "additionalFields": {
          "filterByFormula": "{Campaign}='AI Sales Campaign'"
        }
      },
      "credentials": {
        "airtableTokenApi": {
          "id": "Zir5IhIPeSQs72LR",
          "name": "Airtable UYSP Option C"
        }
      }
    },
    {
      "id": "prep",
      "name": "Prepare Sends (Step 1 only)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -120,
        -80
      ],
      "parameters": {
        "jsCode": "const settings = ($items(\"Get Settings\", 0)[0]?.json?.fields) || ($items(\"Get Settings\", 0)[0]?.json) || {};\nconst aPct = Number(settings.ab_ratio_a || 50);\nconst templates = $items(\"List Templates\", 0).map(i => i.json.fields || i.json);\nfunction pickVariant(existing){\n  if (existing === 'A' || existing === 'B') return existing;\n  const r = Math.random()*100;\n  return r < aPct ? 'A' : 'B';\n}\nfunction tmplFor(variant, step){\n  return templates.find(t => String(t.Variant)===variant && Number(t.Step)===step);\n}\nfunction firstName(rec){\n  return rec['First Name'] || rec['Full Name']?.split(' ')[0] || (rec['Email']||'').split('@')[0] || '';\n}\nconst out = [];\nfor (const item of $items(\"List Leads (SMS Pipeline)\", 0)){\n  const rec = item.json.fields || item.json;\n  if (rec['Booked'] === true) continue;\n  if (rec['SMS Stop'] === true) continue;\n  const pos = Number(rec['SMS Sequence Position'] || 0);\n  if (pos !== 0) continue;\n  const variant = pickVariant(rec['SMS Variant']);\n  const t = tmplFor(variant, 1);\n  if (!t || !t.Body) continue;\n  const name = firstName(rec);\n  const text = String(t.Body).replaceAll('{Name}', name);\n  const rawPhone = rec['Phone'] || '';\n  const phone = String(rawPhone).replace(/\\D/g,'').replace(/^1/,'');\n  if (!phone) continue;\n  out.push({ json: { id: item.json.id || rec.id, phone, text, variant, sentCountNext: Number(rec['SMS Sent Count']||0)+1 } });\n}\nreturn out;"
      }
    },
    {
      "id": "send",
      "name": "SimpleTexting HTTP",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        100,
        -80
      ],
      "parameters": {
        "method": "POST",
        "url": "https://api-app2.simpletexting.com/v2/api/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": {
          "contactPhone": "={{$json.phone}}",
          "accountPhone": "9094988474",
          "mode": "AUTO",
          "text": "={{$json.text}}"
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "E4NDaEmBWVX3rawT",
          "name": "Simple-TXT-API"
        }
      }
    },
    {
      "id": "after",
      "name": "Prepare Update",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        -80
      ],
      "parameters": {
        "jsCode": "const resp = $json;\nconst status = resp?.statusCode ?? 200;\nconst body = resp?.json ?? resp ?? {};\nconst ok = (status===200 || status===201) && !body?.code;\nreturn [{ json: { ok, campaign_id: body.id || body.campaign_id || '', error_reason: body?.message || `HTTP ${status}` } }];"
      }
    },
    {
      "id": "update",
      "name": "Airtable Update",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2,
      "position": [
        540,
        -80
      ],
      "parameters": {
        "operation": "update",
        "base": {
          "mode": "id",
          "value": "app6cU9HecxLpgT0P"
        },
        "table": {
          "mode": "list",
          "value": "tblYUvhGADerbD8EO",
          "__rl": true
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{$json.id}}",
            "SMS Status": "={{$json.ok ? 'Sent':'Failed'}}",
            "SMS Campaign ID": "={{$json.campaign_id}}",
            "SMS Sequence Position": "={{1}}",
            "SMS Sent Count": "={{$json.sentCountNext || 1}}",
            "SMS Last Sent At": "={{$now}}",
            "SMS Variant": "={{$json.variant}}",
            "Error Log": "={{$json.ok ? '' : $json.error_reason}}"
          },
          "matchingColumns": [
            "id"
          ]
        },
        "options": {
          "typecast": true
        }
      },
      "credentials": {
        "airtableTokenApi": {
          "id": "Zir5IhIPeSQs72LR",
          "name": "Airtable UYSP Option C"
        }
      }
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "List Leads (SMS Pipeline)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Settings": {
      "main": [
        [
          {
            "node": "List Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Templates": {
      "main": [
        [
          {
            "node": "Prepare Sends (Step 1 only)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "List Leads (SMS Pipeline)": {
      "main": [
        [
          {
            "node": "Prepare Sends (Step 1 only)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Sends (Step 1 only)": {
      "main": [
        [
          {
            "node": "SimpleTexting HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SimpleTexting HTTP": {
      "main": [
        [
          {
            "node": "Prepare Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update": {
      "main": [
        [
          {
            "node": "Airtable Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true
  },
  "staticData": null,
  "meta": null,
  "pinData": null,
  "versionId": "c5f41e6a-9f15-4546-9625-48370f82276d",
  "triggerCount": 0,
  "shared": [
    {
      "createdAt": "2025-08-28T18:28:21.715Z",
      "updatedAt": "2025-08-28T18:28:21.715Z",
      "role": "workflow:owner",
      "workflowId": "LVmCQpTbKDxfISG6",
      "projectId": "H4VRaaZhd8VKQANf",
      "project": {
        "createdAt": "2025-07-20T10:20:07.367Z",
        "updatedAt": "2025-07-20T10:23:14.000Z",
        "id": "H4VRaaZhd8VKQANf",
        "name": "UYSP Lead Qualification Agent ",
        "type": "team",
        "icon": {
          "type": "icon",
          "value": "layer-group"
        },
        "description": "Automated lead qualification and SMS outreach system that processes Kajabi form submissions, enriches B2B leads through two-phase qualification, scores them 0-100 using AI, and sends personalized SMS to qualified prospects while maintaining strict compliance and cost controls.",
        "projectRelations": [
          {
            "createdAt": "2025-07-20T10:23:14.911Z",
            "updatedAt": "2025-07-20T10:23:14.911Z",
            "role": "project:admin",
            "userId": "29d0ac76-1b0e-4f0b-a9dd-b710d2476efa",
            "projectId": "H4VRaaZhd8VKQANf",
            "user": {
              "createdAt": "2025-07-01T09:55:15.012Z",
              "updatedAt": "2025-08-29T22:42:11.000Z",
              "id": "29d0ac76-1b0e-4f0b-a9dd-b710d2476efa",
              "email": "latifhorst@gmail.com",
              "firstName": "LATIF",
              "lastName": "HORST",
              "personalizationAnswers": null,
              "settings": {
                "userActivated": true,
                "easyAIWorkflowOnboarded": true,
                "firstSuccessfulWorkflowId": "Zdpywk5ic1hYILgr",
                "userActivatedAt": 1751967003557,
                "npsSurvey": {
                  "responded": true,
                  "lastShownAt": 1753035927344
                }
              },
              "role": "global:owner",
              "disabled": false,
              "mfaEnabled": false,
              "lastActiveAt": "2025-08-29",
              "isPending": false
            }
          }
        ]
      }
    }
  ],
  "tags": []
}
