patterns/02-compliance-patterns.txt
Compliance Patterns for 10DLC, DND, TCPA, and pre-flight checks.

Pattern: DND List Initialization
Purpose: Initialize DND_List table with sample data if empty
Required Nodes: Airtable (check if exists), Code (prepare sample data), Airtable (create)
Configuration:
// Node 1: Check DND_List Exists
Type: Airtable
// Node 2: Prepare Sample DND Data
Type: Code
if (existingRecords.length === 0) { return { needs_init: true, sample_records: [...] }; }
// Node 3: Create Sample Records
Type: Airtable
Error Handling: Add DND initialization check.

From SMS Sending Pattern (Extracted 10DLC Check):
// Node 1: Verify 10DLC Registration
Type: Code
const TEN_DLC_REGISTERED = $vars.TEN_DLC_REGISTERED === 'true';
if (!TEN_DLC_REGISTERED) throw 'HALT: Unregistered A2P SMS blocked post-Feb 2025';

From SMS Sending Pattern (Extracted DND Check):
// Node 2: Search DND List
Type: Airtable
// Node 3: Check DND Result
Type: Code
if (dndResults.length > 0) throw new Error('Phone on DND list');

From SMS Sending Pattern (Extracted TCPA Time Check):
// Node 4: Check Send Time
Type: Code
const areaCode = ...; // Timezone map
if (localHour < 8 || localHour > 21) throw new Error('SMS blocked outside 8am-9pm local');

Pattern: SMS Pre-flight Check
Purpose: Combine all SMS compliance checks into single reusable node
Required Nodes: Code (all checks combined)
Configuration:
// Node 1: SMS Pre-flight Check
Type: Code
// 1. Check 10DLC, 2. Monthly count, 3. DND, 4. Time window, 5. Duplicate, 6. Test mode
return { sms_preflight_passed: true, ... };
Error Handling: Throws specific errors for each failure.

Pattern: Universal Retry Pattern
Purpose: Handle 429 rate limit errors gracefully
Required Nodes: HTTP Request (with n8n retry), Code (custom retry)
Configuration:
// Node 1: Simple n8n Native Retry
Type: HTTP Request
Retry On Fail: true
Error Handling: Log retry patterns.